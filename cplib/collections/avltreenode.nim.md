---
data:
  _extendedDependsOn: []
  _extendedRequiredBy:
  - icon: ':heavy_check_mark:'
    path: cplib/collections/avlset.nim
    title: cplib/collections/avlset.nim
  - icon: ':heavy_check_mark:'
    path: cplib/collections/avlset.nim
    title: cplib/collections/avlset.nim
  - icon: ':warning:'
    path: cplib/collections/rangeset.nim
    title: cplib/collections/rangeset.nim
  - icon: ':warning:'
    path: cplib/collections/rangeset.nim
    title: cplib/collections/rangeset.nim
  - icon: ':warning:'
    path: cplib/utils/grid_searcher.nim
    title: cplib/utils/grid_searcher.nim
  - icon: ':warning:'
    path: cplib/utils/grid_searcher.nim
    title: cplib/utils/grid_searcher.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC217_gele_test_.nim
    title: verify/collections/avlset/multiset/ABC217_gele_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC217_gele_test_.nim
    title: verify/collections/avlset/multiset/ABC217_gele_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC217_gtlt_test_.nim
    title: verify/collections/avlset/multiset/ABC217_gtlt_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC217_gtlt_test_.nim
    title: verify/collections/avlset/multiset/ABC217_gtlt_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC217_index_test_.nim
    title: verify/collections/avlset/multiset/ABC217_index_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC217_index_test_.nim
    title: verify/collections/avlset/multiset/ABC217_index_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC234D_access_test_.nim
    title: verify/collections/avlset/multiset/ABC234D_access_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC234D_access_test_.nim
    title: verify/collections/avlset/multiset/ABC234D_access_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC236_test_.nim
    title: verify/collections/avlset/multiset/ABC236_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC236_test_.nim
    title: verify/collections/avlset/multiset/ABC236_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC294_test_.nim
    title: verify/collections/avlset/multiset/ABC294_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC294_test_.nim
    title: verify/collections/avlset/multiset/ABC294_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC337_test_.nim
    title: verify/collections/avlset/multiset/ABC337_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/ABC337_test_.nim
    title: verify/collections/avlset/multiset/ABC337_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/index_right_test_.nim
    title: verify/collections/avlset/multiset/index_right_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/multiset/index_right_test_.nim
    title: verify/collections/avlset/multiset/index_right_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC217_gele_test_.nim
    title: verify/collections/avlset/set/ABC217_gele_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC217_gele_test_.nim
    title: verify/collections/avlset/set/ABC217_gele_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC217_gtlt_test_.nim
    title: verify/collections/avlset/set/ABC217_gtlt_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC217_gtlt_test_.nim
    title: verify/collections/avlset/set/ABC217_gtlt_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC217_index_test_.nim
    title: verify/collections/avlset/set/ABC217_index_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC217_index_test_.nim
    title: verify/collections/avlset/set/ABC217_index_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC234D_access_test_.nim
    title: verify/collections/avlset/set/ABC234D_access_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC234D_access_test_.nim
    title: verify/collections/avlset/set/ABC234D_access_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC236_test_.nim
    title: verify/collections/avlset/set/ABC236_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC236_test_.nim
    title: verify/collections/avlset/set/ABC236_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC294_test_.nim
    title: verify/collections/avlset/set/ABC294_test_.nim
  - icon: ':warning:'
    path: verify/collections/avlset/set/ABC294_test_.nim
    title: verify/collections/avlset/set/ABC294_test_.nim
  - icon: ':warning:'
    path: verify/collections/rangeset_test_.nim
    title: verify/collections/rangeset_test_.nim
  - icon: ':warning:'
    path: verify/collections/rangeset_test_.nim
    title: verify/collections/rangeset_test_.nim
  - icon: ':warning:'
    path: verify/utils/grid_searcher/skate_get_test_.nim
    title: verify/utils/grid_searcher/skate_get_test_.nim
  - icon: ':warning:'
    path: verify/utils/grid_searcher/skate_get_test_.nim
    title: verify/utils/grid_searcher/skate_get_test_.nim
  - icon: ':warning:'
    path: verify/utils/grid_searcher/skate_get_tuple_test_.nim
    title: verify/utils/grid_searcher/skate_get_tuple_test_.nim
  - icon: ':warning:'
    path: verify/utils/grid_searcher/skate_get_tuple_test_.nim
    title: verify/utils/grid_searcher/skate_get_tuple_test_.nim
  - icon: ':warning:'
    path: verify/utils/grid_searcher/skate_test_.nim
    title: verify/utils/grid_searcher/skate_test_.nim
  - icon: ':warning:'
    path: verify/utils/grid_searcher/skate_test_.nim
    title: verify/utils/grid_searcher/skate_test_.nim
  - icon: ':warning:'
    path: verify/utils/grid_searcher/skate_tuple_test_.nim
    title: verify/utils/grid_searcher/skate_tuple_test_.nim
  - icon: ':warning:'
    path: verify/utils/grid_searcher/skate_tuple_test_.nim
    title: verify/utils/grid_searcher/skate_tuple_test_.nim
  _extendedVerifiedWith:
  - icon: ':heavy_check_mark:'
    path: verify/collections/avlset/set/ordered_set_test.nim
    title: verify/collections/avlset/set/ordered_set_test.nim
  - icon: ':heavy_check_mark:'
    path: verify/collections/avlset/set/ordered_set_test.nim
    title: verify/collections/avlset/set/ordered_set_test.nim
  _isVerificationFailed: false
  _pathExtension: nim
  _verificationStatusIcon: ':heavy_check_mark:'
  attributes:
    links:
    - https://nachiavivias.github.io/cp-library/cpp/array/bbst-list.html
  bundledCode: "Traceback (most recent call last):\n  File \"/home/runner/.local/lib/python3.12/site-packages/onlinejudge_verify/documentation/build.py\"\
    , line 71, in _render_source_code_stat\n    bundled_code = language.bundle(stat.path,\
    \ basedir=basedir, options={'include_paths': [basedir]}).decode()\n          \
    \         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n\
    \  File \"/home/runner/.local/lib/python3.12/site-packages/onlinejudge_verify/languages/nim.py\"\
    , line 86, in bundle\n    raise NotImplementedError\nNotImplementedError\n"
  code: "when not declared CPLIB_COLLECTIONS_AVLTREE:\n    const CPLIB_COLLECTIONS_AVLTREE*\
    \ = 1\n    # \u4EE5\u4E0B\u3092Nim\u306B\u79FB\u690D\n    # https://nachiavivias.github.io/cp-library/cpp/array/bbst-list.html\n\
    \    type AvlTreeNode*[K] = ref object\n        l*, r*, p*: AvlTreeNode[K]\n \
    \       h*, len*: int\n        key*: K\n    proc update[K](node: AvlTreeNode[K])\
    \ =\n        node.h = 0\n        node.len = 1\n        if not node.l.isNil:\n\
    \            if node.l.h + 1 > node.h: node.h = node.l.h + 1\n            node.len\
    \ += node.l.len\n        if not node.r.isNil:\n            if node.r.h + 1 > node.h:\
    \ node.h = node.r.h + 1\n            node.len += node.r.len\n    proc set_children[K](node,\
    \ l, r: AvlTreeNode[K]) =\n        node.l = l\n        if not l.isNil: l.p = node\n\
    \        node.r = r\n        if not r.isNil: r.p = node\n        node.update()\n\
    \    proc rebalance[K](node: AvlTreeNode[K]): AvlTreeNode[K] =\n        var node\
    \ = node\n        var l = node.l\n        var r = node.r\n        var lh = if\
    \ not l.isNil: l.h else: 0\n        var rh = if not r.isNil: r.h else: 0\n   \
    \     if lh + 1 < rh:\n            var rl = r.l\n            var rr = r.r\n  \
    \          var rlh = if not rl.isNil: rl.h else: 0\n            var rrh = if not\
    \ rr.isNil: rr.h else: 0\n            if rlh <= rrh:\n                r.p = node.p\n\
    \                node.set_children(l, rl)\n                r.set_children(node,\
    \ rr)\n                return r\n            else:\n                rl.p = node.p\n\
    \                node.set_children(l, rl.l)\n                r.set_children(rl.r,\
    \ rr)\n                rl.set_children(node, r)\n                return rl\n \
    \       elif rh + 1 < lh:\n            var ll = l.l\n            var lr = l.r\n\
    \            var llh = if not ll.isNil: ll.h else: 0\n            var lrh = if\
    \ not lr.isNil: lr.h else: 0\n            if lrh <= llh:\n                l.p\
    \ = node.p\n                node.set_children(lr, r)\n                l.set_children(ll,\
    \ node)\n                return l\n            else:\n                lr.p = node.p\n\
    \                node.set_children(lr.r, r)\n                l.set_children(ll,\
    \ lr.l)\n                lr.set_children(l, node)\n                return lr\n\
    \        node.update\n        return node\n    proc rebalance_to_root[K](node:\
    \ AvlTreeNode[K]): AvlTreeNode[K] =\n        var node = node\n        while not\
    \ node.p.isNil:\n            var cp = node.p\n            if cp.l == node: cp.l\
    \ = node.rebalance\n            else: cp.r = node.rebalance\n            node\
    \ = cp\n        return node.rebalance\n    proc rootOf*[K](node: AvlTreeNode[K]):\
    \ AvlTreeNode[K] =\n        result = node\n        while not result.p.isNil: result\
    \ = result.p\n    proc node_search[K](node: AvlTreeNode[K], key: K, strict: bool):\
    \ (AvlTreeNode[K], AvlTreeNode[K]) =\n        var node = node\n        var result_l:\
    \ AvlTreeNode[K] = nil\n        var result_r: AvlTreeNode[K] = nil\n        while\
    \ not node.isNil:\n            if (strict and key < node.key) or (not strict and\
    \ key <= node.key):\n                result_r = node\n                node = node.l\n\
    \            else:\n                result_l = node\n                node = node.r\n\
    \        return (result_l, result_r)\n    proc lower_bound_node*[K](node: AvlTreeNode[K],\
    \ key: K): (AvlTreeNode[K], AvlTreeNode[K]) = node_search[K](node, key, false)\n\
    \    proc upper_bound_node*[K](node: AvlTreeNode[K], key: K): (AvlTreeNode[K],\
    \ AvlTreeNode[K]) = node_search[K](node, key, true)\n    proc insert*[K](node,\
    \ x: AvlTreeNode[K]): AvlTreeNode[K] =\n        if node.isNil: return x\n    \
    \    var (ql, qr) = node.lower_bound_node(x.key)\n        if not ql.isNil and\
    \ ql.r.isNil:\n            ql.set_children(ql.l, x)\n            return ql.rebalance_to_root\n\
    \        qr.set_children(x, qr.r)\n        return qr.rebalance_to_root\n    proc\
    \ erase*[K](node, x, nxt: AvlTreeNode[K]): AvlTreeNode[K] =\n        var xp =\
    \ x.p\n        if x.r.isNil:\n            var xl = x.l\n            if not xl.isNil:\
    \ xl.p = xp\n            if not xp.isNil:\n                if xp.l == x: xp.l\
    \ = xl\n                else: xp.r = xl\n            if xp.isNil: result = xl\n\
    \            else: result = xp.rebalance_to_root\n        else:\n            var\
    \ nxtp = nxt.p\n            var nxtr = nxt.r\n            if not xp.isNil:\n \
    \               if xp.l == x: xp.l = nxt\n                else: xp.r = nxt\n \
    \           nxt.p = xp\n            nxt.l = x.l\n            if not nxt.l.isNil:\
    \ nxt.l.p = nxt\n            if x.r == nxt:\n                nxt.update\n    \
    \            result = nxt.rebalance_to_root\n            else:\n             \
    \   if nxtp.l == nxt: nxtp.l = nxtr\n                else: nxtp.r = nxtr\n   \
    \             if not nxtr.isNil: nxtr.p = nxtp\n                nxt.r = x.r\n\
    \                nxt.r.p = nxt\n                nxt.update\n                result\
    \ = nxtp.rebalance_to_root\n        x.l = nil\n        x.r = nil\n        x.p\
    \ = nil\n        x.update\n    proc next*[K](node: AvlTreeNode[K]): AvlTreeNode[K]\
    \ =\n        var node = node\n        if not node.r.isNil:\n            node =\
    \ node.r\n            while not node.l.isNil: node = node.l\n            return\
    \ node\n        while not node.p.isNil and node.p.r == node: node = node.p\n \
    \       return node.p\n    proc prev*[K](node: AvlTreeNode[K]): AvlTreeNode[K]\
    \ =\n        var node = node\n        if not node.l.isNil:\n            node =\
    \ node.l\n            while not node.r.isNil: node = node.r\n            return\
    \ node\n        while not node.p.isNil and node.p.l == node: node = node.p\n \
    \       return node.p\n    proc get*[K](node: AvlTreeNode[K], idx: int): AvlTreeNode[K]\
    \ =\n        assert idx >= 0\n        if idx >= node.len: return nil\n       \
    \ result = node\n        var idx = idx\n        while (result.l.isNil and idx\
    \ != 0) or (not result.l.isNil and result.l.len != idx):\n            if result.l.isNil\
    \ or result.l.len < idx:\n                idx -= (if result.l.isNil: 1 else: result.l.len\
    \ + 1)\n                assert(not result.r.isNil)\n                result = result.r\n\
    \            else:\n                result = result.l\n    proc index*[K](node:\
    \ AvlTreeNode[K]): int =\n        var node = node\n        if node.isNil: return\
    \ 0\n        result = (if node.l.isNil: 0 else: node.l.len)\n        while not\
    \ node.p.isNil:\n            if node.p.r == node:\n                if node.p.l.isNil:\
    \ result += 1\n                else: result += node.p.l.len + 1\n            node\
    \ = node.p\n"
  dependsOn: []
  isVerificationFile: false
  path: cplib/collections/avltreenode.nim
  requiredBy:
  - verify/utils/grid_searcher/skate_get_test_.nim
  - verify/utils/grid_searcher/skate_get_test_.nim
  - verify/utils/grid_searcher/skate_get_tuple_test_.nim
  - verify/utils/grid_searcher/skate_get_tuple_test_.nim
  - verify/utils/grid_searcher/skate_test_.nim
  - verify/utils/grid_searcher/skate_test_.nim
  - verify/utils/grid_searcher/skate_tuple_test_.nim
  - verify/utils/grid_searcher/skate_tuple_test_.nim
  - verify/collections/rangeset_test_.nim
  - verify/collections/rangeset_test_.nim
  - verify/collections/avlset/set/ABC294_test_.nim
  - verify/collections/avlset/set/ABC294_test_.nim
  - verify/collections/avlset/set/ABC217_gele_test_.nim
  - verify/collections/avlset/set/ABC217_gele_test_.nim
  - verify/collections/avlset/set/ABC217_index_test_.nim
  - verify/collections/avlset/set/ABC217_index_test_.nim
  - verify/collections/avlset/set/ABC236_test_.nim
  - verify/collections/avlset/set/ABC236_test_.nim
  - verify/collections/avlset/set/ABC217_gtlt_test_.nim
  - verify/collections/avlset/set/ABC217_gtlt_test_.nim
  - verify/collections/avlset/set/ABC234D_access_test_.nim
  - verify/collections/avlset/set/ABC234D_access_test_.nim
  - verify/collections/avlset/multiset/ABC294_test_.nim
  - verify/collections/avlset/multiset/ABC294_test_.nim
  - verify/collections/avlset/multiset/ABC217_gele_test_.nim
  - verify/collections/avlset/multiset/ABC217_gele_test_.nim
  - verify/collections/avlset/multiset/ABC337_test_.nim
  - verify/collections/avlset/multiset/ABC337_test_.nim
  - verify/collections/avlset/multiset/ABC217_index_test_.nim
  - verify/collections/avlset/multiset/ABC217_index_test_.nim
  - verify/collections/avlset/multiset/ABC236_test_.nim
  - verify/collections/avlset/multiset/ABC236_test_.nim
  - verify/collections/avlset/multiset/ABC217_gtlt_test_.nim
  - verify/collections/avlset/multiset/ABC217_gtlt_test_.nim
  - verify/collections/avlset/multiset/index_right_test_.nim
  - verify/collections/avlset/multiset/index_right_test_.nim
  - verify/collections/avlset/multiset/ABC234D_access_test_.nim
  - verify/collections/avlset/multiset/ABC234D_access_test_.nim
  - cplib/utils/grid_searcher.nim
  - cplib/utils/grid_searcher.nim
  - cplib/collections/avlset.nim
  - cplib/collections/avlset.nim
  - cplib/collections/rangeset.nim
  - cplib/collections/rangeset.nim
  timestamp: '2025-04-27 19:08:43+09:00'
  verificationStatus: LIBRARY_ALL_AC
  verifiedWith:
  - verify/collections/avlset/set/ordered_set_test.nim
  - verify/collections/avlset/set/ordered_set_test.nim
documentation_of: cplib/collections/avltreenode.nim
layout: document
redirect_from:
- /library/cplib/collections/avltreenode.nim
- /library/cplib/collections/avltreenode.nim.html
title: cplib/collections/avltreenode.nim
---
